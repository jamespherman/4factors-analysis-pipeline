# Analysis Data Dictionary

This document has two parts. First, it defines the canonical data structure for the `session_data.analysis` field. All per-session analysis functions must save their results in this format. Second, it defines the `analysis_plan` that is used to guide the analyses that are run.

The guiding principle is to organize data by **Analysis Type -> Alignment Event -> Condition/Comparison Name**.

---
## Session-Specific Condition Masks (`conditions`)

When `define_task_conditions.m` is called with `session_data`, it returns a `conditions` struct. This struct contains a series of logical vectors (masks) that identify which trials meet a specific experimental condition.

All masks within this struct are the same length and have been pre-filtered to include only successfully completed trials from the '4factors' task. This allows for direct, element-wise logical operations between them. For example, to find all high-reward trials that were presented in the receptive field, one could use `conditions.is_in_rf & conditions.is_high_reward`.

### Fields

-   `.is_in_rf`: `logical` - `true` for trials where the target was presented inside the neuron's receptive field (RF).
-   `.is_out_of_rf`: `logical` - `true` for trials where the target was presented outside the RF.
-   `.is_high_reward`: `logical` - `true` for trials with a high reward outcome.
-   `.is_low_reward`: `logical` - `true` for trials with a low reward outcome.
-   `.is_high_salience`: `logical` - `true` for trials where the target was of high visual salience.
-   `.is_low_salience`: `logical` - `true` for trials where the target was of low visual salience.
-   `.is_face_target`: `logical` - `true` for trials where the target was a 'face' stimulus.
-   `.is_nonface_target`: `logical` - `true` for trials where the target was a 'non-face' stimulus.
-   `.is_image_target`: `logical` - `true` for trials where the target was either a face or a non-face stimulus.
-   `.is_high_probability`: `logical` - `true` for trials where the target was in a high-probability spatial location.
-   `.is_low_probability`: `logical` - `true` for trials where the target was in a low-probability spatial location.

---
## Analysis Plan Input Structure (`analysis_plan`)

The `analysis_plan` structure is generated by `define_task_conditions.m` (when called with no arguments) and serves as the primary input for driving the main analysis scripts. It defines which analyses to run, what conditions to compare, and how to configure them.

-   **Path:** This is a standalone struct, typically loaded at the beginning of an analysis script, e.g., `analysis_plan = define_task_conditions();`.

### Fields

-   `.alignment_events`: `[1 x nEvents] cell` - A cell array of character vectors, where each entry specifies an event to which neural data should be aligned (e.g., `'targetOn'`, `'saccadeOnset'`).

-   `.baseline_plan`: `[1 x nConditions] struct array` - Defines the set of "Baseline vs. Post-Event Activity" analyses to run. Each element of the array is a struct with the following field:
    -   `.name`: `char` - The name of the condition to be analyzed (e.g., `'is_high_reward'`). This name must correspond to one of the fields generated by `define_4factors_task_conditions(session_data)`.

-   `.roc_plan`: `[1 x nComps] struct array` - Defines the set of ROC-based comparisons to run. Each element of the array is a struct with the following fields:
    -   `.name`: `char` - The name of the comparison (e.g., `'reward'`).
    -   `.event`: `char` - The alignment event to use for this comparison.
    -   `.cond1`: `char` - The name of the first condition.
    -   `.cond2`: `char` - The name of the second condition.
    -   `.trial_mask`: `char` - The name of a logical mask to select a subset of trials for this comparison (e.g., `'is_in_rf'`).

-   `.anova_plan`: `struct` - Defines the parameters for running the N-way ANOVA.
    -   `.run`: `boolean` - A flag indicating whether to run the ANOVA.
    -   `.event`: `char` - The alignment event to use for the ANOVA.
    -   `.factors`: `[1 x nFactors] cell` - A cell array of character vectors with the names of the factors for the ANOVA (e.g., `'reward'`, `'salience'`).
    -   `.trial_mask`: `char` - The name of a logical mask to select a subset of trials.

-   `.diagnostic_plots`: `[1 x nPlots] struct array` - Defines the set of diagnostic plots to be generated for each neuron.
    -   `.event`: `char` - The alignment event for the plot.
    -   `.title`: `char` - The title of the plot panel.
    -   `.conditions_to_compare`: `[1 x nConditions] cell` - The names of the conditions to be plotted together.

-   `.behavior_plan`: `[1 x nAnalyses] struct array` - Defines the set of behavioral analyses to run using a linear mixed-effects model. Each element of the array is a struct with the following fields:
    -   `.name`: `char` - The name of the analysis (e.g., `'ReactionTime'`). This will be used to name the output field.
    -   `.dependent_variable`: `cell` - A cell array defining the dependent variable. It can be a single field name (e.g., `{'peakVelocity'}`), a subtraction (e.g., `{'timingInfo.saccadeOnset', '-', 'timingInfo.goCue'}`), or a special calculation (e.g., `{'endpoint_error'}`).
    -   `.factors`: `[1 x nFactors] cell` - A cell array of character vectors with the names of the factors for the model (e.g., `{'reward', 'salience'}`).
    -   `.trial_mask`: `char` - The name of a logical mask to select a subset of trials for this analysis.

-   `.decoding_plan`: `struct` - Defines the population decoding analysis, which is split into a training plan and a testing plan.
    -   `.training_plan`: `[1 x nModels] struct array` - Defines the set of classifiers to be trained. Each element has the following fields:
        -   `.model_tag`: `char` - A unique identifier for the trained model (e.g., `'Reward_Visual'`).
        -   `.align_event`: `char` - The event to align neural data to (e.g., `'targetOn'`).
        -   `.time_window`: `[1x2] double` - The time window relative to the `align_event` for feature extraction.
        -   `.cond1`, `.cond2`: `char` - The names of the two conditions to classify.
        -   `.trial_mask`: `char` or `cell` - A mask to select a subset of trials.
    -   `.testing_plan`: `[1 x nTests] struct array` - Defines the set of generalization tests to perform using the trained models. Each element has a `.type` field (`'cross_factor'` or `'cross_time'`) and other fields that depend on the type.
        -   **Common Fields:**
            -   `.test_name`: `char` - A unique name for the test (e.g., `'Reward_x_Salience_Visual'`).
            -   `.type`: `char` - The type of test: `'cross_factor'` or `'cross_time'`.
            -   `.train_model_tag`: `char` - The `model_tag` of the trained classifier to use.
            -   `.test_cond1`, `.test_cond2`: `char` - The condition labels for the test data.
            -   `.trial_mask`: `char` or `cell` - A mask to select a subset of trials for testing.
        -   **For `'cross_factor'` tests:**
            -   `.align_event`: `char` - The alignment event for the test data.
            -   `.time_window`: `[1x2] double` - The time window for the test data.
        -   **For `'cross_time'` tests:**
            -   `.test_align_event`: `char` - The alignment event for the test data.
            -   `.test_time_window`: `[1x2] double` - The time window for the test data.

## Top-Level Output Structure (`session_data.analysis`)

-   `session_data.analysis`
    -   `.roc_comparison`: Results from `analyze_roc_comparison.m`
    -   `.baseline_comparison`: Results from `analyze_baseline_comparison.m`
    -   `.anova_results`: Results from `analyze_anova.m`
    -   `.behavioral_results`: Results from `analyze_behavior.m`
-   `.population_decoding`: Results from `analyze_population_decoding.m`
    -   `.selected_neurons`: List of neurons selected for analysis.
    -   `.core_data`: Processed data used for analyses.
    -   `.scSide` (for SC sessions): The determined side of the Superior Colliculus recording ('left' or 'right').
    -   `.sig_epoch_comparison` (for SC sessions): Significance of epoch comparisons from `screen_sc_neurons.m`.

---

## 1. ROC Comparison

Compares firing rates between two conditions.

-   **Path:** `session_data.analysis.roc_comparison.(eventName).(compName)`
-   **`eventName`**: `char` - The name of the alignment event (e.g., `'CUE_ON'`, `'outcomeOn'`).
-   **`compName`**: `char` - The name of the specific comparison (e.g., `'Dist_at_Cue'`, `'RPE_at_Outcome'`).

### Fields

-   `.sig`: `[nNeurons x nTimeBins] double` - Matrix of p-values from the ROC analysis at each time bin.
-   `.time_vector`: `[1 x nTimeBins] double` - The time vector corresponding to the columns of `.sig`.
-   `.cond_names`: `[1 x 2] cell` - Cell array containing the names of the two conditions that were compared (e.g., `{'is_normal_dist', 'is_uniform_dist'}`).

---

## 2. Baseline Comparison

Compares post-event firing rates to a pre-event baseline period.

-   **Path:** `session_data.analysis.baseline_comparison.(eventName).(condName)`
-   **`eventName`**: `char` - The name of the alignment event (e.g., `'CUE_ON'`, `'outcomeOn'`).
-   **`condName`**: `char` - The name of the condition being analyzed (e.g., `'is_normal_dist'`, `'is_common_reward_no_spe'`).

### Fields

-   `.sig`: `[nNeurons x nTimeBins] double` - Matrix of p-values from the ROC analysis comparing each post-event bin to the pooled baseline.
-   `.time_vector`: `[1 x nTimeBins] double` - The time vector for the post-event period, corresponding to the columns of `.sig`.

---

## 3. ANOVA Results

Results from the N-way ANOVA analysis.

-   **Path:** `session_data.analysis.anova_results.(eventName).(p_value_name)`
-   **`eventName`**: `char` - The name of the alignment event (e.g., `'CUE_ON'`).
-   **`p_value_name`**: `char` - The name of the factor or interaction term for which p-values are reported (e.g., `'p_interaction'`, `'p_value'`).

### Fields

The fields under `(p_value_name)` are typically `[nNeurons x nTimeBins]` double matrices containing the p-values for that factor over time.

---

## 4. Behavioral Analysis Results

Stores the output from the `analyze_behavior.m` function. The results are generated by fitting a linear mixed-effects model (`fitlme`) to the behavioral data.

-   **Path:** `session_data.analysis.behavioral_results.(analysisName)`
-   **`analysisName`**: `char` - The name of the specific behavioral analysis, taken from the `.name` field in the `behavior_plan` (e.g., `'ReactionTime'`, `'PeakVelocity'`).

### Fields

The `(analysisName)` field contains a table which is the direct output of the `anova` method called on the `fitlme` model object. This table contains the statistics for each factor and interaction term. The columns typically include:

| Column | Description |
| :--- | :--- |
| `Effect` | The name of the model term (e.g., 'reward', 'salience', 'reward:salience'). |
| `FStat` | The F-statistic for the model term. |
| `DF1` | The numerator degrees of freedom. |
| `DF2` | The denominator degrees of freedom. |
| `pValue` | The p-value indicating the significance of the model term. |
---

## 5. Population Decoding Results

Stores the output from the `analyze_population_decoding.m` function. The results are generated by training and testing SVM classifiers on neural population activity.

Results are saved in a structure where the field names are dynamically generated. For each model in the `training_plan`, a field is created with the `model_tag` name (e.g., `session_data.analysis.population_decoding.Reward_Visual`). This field stores the cross-validated classification accuracy for that model.

For each test in the `testing_plan`, a field is created with the `test_name` (e.g., `session_data.analysis.population_decoding.Reward_x_Salience_Visual`). This field stores the accuracy of the specified generalization test.

-   **Path:** `session_data.analysis.population_decoding.(analysisName)`
-   **`analysisName`**: `char` - The name of the specific decoding analysis, taken from the `model_tag` in the `training_plan` or the `test_name` in the `testing_plan`.

### Fields

-   `.accuracy`: `double` - The classification accuracy. For a trained model, this is the cross-validated accuracy. For a generalization test, this is the accuracy on the held-out test set.
