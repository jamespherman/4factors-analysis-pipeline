# Analysis Data Dictionary

This document has two parts. First, it defines the canonical data structure for the `session_data.analysis` field. All per-session analysis functions must save their results in this format. Second, it defines the `analysis_plan` that is used to guide the analyses that are run.

The guiding principle is to organize data by **Analysis Type -> Alignment Event -> Condition/Comparison Name**.

---
## Session-Specific Condition Masks (`conditions`)

When `define_task_conditions.m` is called with `session_data`, it returns a `conditions` struct. This struct contains a series of logical vectors (masks) that identify which trials meet a specific experimental condition.

All masks within this struct are the same length and have been pre-filtered to include only successfully completed trials from the '4factors' task. This allows for direct, element-wise logical operations between them. For example, to find all high-reward trials that were presented in the receptive field, one could use `conditions.is_in_rf & conditions.is_high_reward`.

### Fields

-   `.is_contralateral_target`: `logical` - `true` for trials where the target was presented in the visual field contralateral to the recorded SC hemisphere.
-   `.is_ipsilateral_target`: `logical` - `true` for trials where the target was presented in the visual field ipsilateral to the recorded SC hemisphere.
-   `.is_opposite_rf`: `logical` - `true` for trials where the target was presented in the location directly opposite the contralateral RF (e.g., location 3 if RF is at location 1).
-   `.is_high_reward`: `logical` - `true` for trials with a high reward outcome.
-   `.is_low_reward`: `logical` - `true` for trials with a low reward outcome.
-   `.is_high_salience`: `logical` - `true` for trials where the target was of high visual salience.
-   `.is_low_salience`: `logical` - `true` for trials where the target was of low visual salience.
-   `.is_face_target`: `logical` - `true` for trials where the target was a 'face' stimulus.
-   `.is_nonface_target`: `logical` - `true` for trials where the target was a 'non-face' stimulus.
-   `.is_image_target`: `logical` - `true` for trials where the target was either a face or a non-face stimulus.
-   `.is_bullseye_target`: `logical` - `true` for trials where the target was a bullseye stimulus (`stimType > 2`).
-   `.is_high_probability`: `logical` - `true` for trials where the target was in a high-probability spatial location.
-   `.is_low_probability`: `logical` - `true` for trials where the target was in a low-probability spatial location.

### Sub-struct: `.factors`

In addition to the logical masks, the `conditions` struct contains a `.factors` sub-struct. This struct holds cell arrays of categorical labels for each of the primary experimental factors, ready for use in statistical models like ANOVA. Like the logical masks, these cell arrays are pre-filtered to include only valid '4factors' trials.

-   `.factors.identity`: `cell` - Contains the labels `'face'`, `'nonface'`, or `'bullseye'` for each trial.
-   `.factors.saliency`: `cell` - Contains the labels `'high'`, `'low'`, or `'neutral'` for each trial. `'neutral'` corresponds to bullseye trials where salience is not applicable.
-   `.factors.reward`: `cell` - Contains the labels `'high'` or `'low'` for each trial.
-   `.factors.probability`: `cell` - Contains the labels `'high'` or `'low'` for each trial, based on the data-driven spatial probability.

### Sub-struct: `.dvs`

This sub-struct contains pre-calculated dependent variable (DV) vectors for behavioral analyses. Each vector is calculated and then filtered by the same master mask as the logical and factor fields, ensuring that all fields in the `conditions` struct are of the same length. This is the source of data for the `analyze_behavior.m` script.

-   `.dvs.reaction_time`: `double` - The time from `fixOff` to `saccadeOnset` for each trial, in seconds.
-   `.dvs.peakVel`: `double` - The peak velocity of the saccade for each trial.
-   `.dvs.endpoint_error`: `double` - The Euclidean distance between the saccade endpoint and the target center for each trial.

---
## Analysis Plan Input Structure (`analysis_plan`)

The `analysis_plan` structure is generated by `define_task_conditions.m` (when called with no arguments) and serves as the primary input for driving the main analysis scripts. It defines which analyses to run, what conditions to compare, and how to configure them.

-   **Path:** This is a standalone struct, typically loaded at the beginning of an analysis script, e.g., `analysis_plan = define_task_conditions();`.

### Fields

-   `.events`: `[1 x nEvents] cell` - The master list of alignment events for all time-resolved analyses (e.g., `'fixOn'`, `'targetOn'`). This list defines the complete set of events for which analyses like ANOVA will be run.

-   `.event_field_names`: `[1 x nFields] cell` - A cell array of character vectors that specifies which struct fields in the analysis plans contain event names. This allows for centralized control over event discovery. For example: `{'event', 'train_event', 'test_event'}`.

-   `.baseline_fr_config`: `struct` - Defines the parameters for the baseline firing rate calculation. This provides a standardized way to compute a reference firing rate.
    -   `.task_name`: `char` - The name of the task to use for selecting trials (e.g., `'gSac_4factors'`).
    -   `.event`: `char` - The event to align the window to (e.g., `'fixOn'`).
    -   `.window`: `[1x2] double` - The time window relative to the event `[start, end]` in seconds.

-   `.baseline_plan`: `[1 x nConditions] struct array` - Defines the set of "Baseline vs. Post-Event Activity" analyses to run. Each element of the array is a struct with the following field:
    -   `.name`: `char` - The name of the condition to be analyzed (e.g., `'is_high_reward'`). This name must correspond to one of the fields generated by `define_4factors_task_conditions(session_data)`.

-   `.roc_plan`: `[1 x nComps] struct array` - Defines the set of ROC-based comparisons to run. Each element of the array is a struct with the following fields:
    -   `.name`: `char` - The name of the comparison (e.g., `'reward'`).
    -   `.event`: `char` - The alignment event to use for this comparison.
    -   `.cond1`: `char` - The name of the first condition.
    -   `.cond2`: `char` - The name of the second condition.
    -   `.trial_mask`: `char` - The name of a logical mask to select a subset of trials for this comparison (e.g., `'is_in_rf'`).

-   `.anova_plan`: `[1 x 2] struct array` - Defines the two ANOVA models to be run. Each element in the array is a struct with the following fields:
    -   `.name`: `char` - The unique name for this analysis model (e.g., `'anova_imagetrials'`).
    -   `.run`: `boolean` - A flag indicating whether to run this ANOVA.
    -   `.factors`: `cell` - A cell array of strings specifying the factors for the model (e.g., `{'reward', 'identity'}`).
    -   `.trial_mask`: `cell` - A cell array of logical mask names used to select trials for this model (e.g., `{'is_contralateral_target', 'is_image_target'}`).

    **Note:** The ANOVA models defined in this plan are intended to be run for each event specified in the `analysis_plan.events` list.

-   `.diagnostic_plots`: `[1 x nPlots] struct array` - Defines the set of diagnostic plots to be generated for each neuron.
    -   `.event`: `char` - The alignment event for the plot.
    -   `.title`: `char` - The title of the plot panel.
    -   `.conditions_to_compare`: `[1 x nConditions] cell` - The names of the conditions to be plotted together.

-   `.behavior_plan`: `[1 x nAnalyses] struct array` - Defines the set of behavioral analyses to run. Each element corresponds to one model for one behavioral measure.
    -   `.name`: `char` - The unique name for the analysis (e.g., `'reaction_time_imagetrials'`), which will be used as the field name in the results struct.
    -   `.dependent_variable`: `cell` - A cell array defining the dependent variable.
    -   `.factors`: `cell` - A cell array of factor names for the model.
    -   `.trial_mask`: `cell` - A cell array of logical mask names to select trials.

-   `.decoding_plan`: `struct` - Defines the population decoding analysis, which is split into a training plan and a testing plan.
    -   `.training_plan`: `[1 x nModels] struct array` - Defines the set of classifiers to be trained. Each element has the following fields:
        -   `.model_tag`: `char` - A unique identifier for the trained model (e.g., `'Reward_Visual'`).
        -   `.event`: `char` - The event to align neural data to (e.g., `'targetOn'`).
        -   `.time_window`: `[1x2] double` - The time window relative to the `event` for feature extraction.
        -   `.cond1`, `.cond2`: `char` - The names of the two conditions to classify.
        -   `.trial_mask`: `char` or `cell` - A mask to select a subset of trials.
    -   `.testing_plan`: `[1 x nTests] struct array` - Defines the set of tests to perform. Each element has a `.type` field (`'cross_factor'`, `'cross_time'`, or `'standard'`) and other fields that depend on the type.
        -   **Common Fields:**
            -   `.test_name`: `char` - A unique name for the test (e.g., `'Reward_Visual_CV'`).
            -   `.type`: `char` - The type of test: `'cross_factor'`, `'cross_time'`, or `'standard'`.
            -   `.train_model_tag`: `char` - The `model_tag` of the trained classifier to use.
        -   **For `'standard'` and `'cross_factor'` tests:**
            -   `.event`: `char` - The alignment event for the test data. For `cross_factor` tests, this should match the training event.
            -   `.time_window`: `[1x2] double` - The time window for the test data.
            -   `.test_cond1`, `.test_cond2`: `char` - The condition labels for the test data.
            -   `.trial_mask`: `char` or `cell` - A mask to select a subset of trials for testing.
        -   **For `'cross_time'` tests:**
            -   `.train_event`: `char` - The alignment event of the trained model.
            -   `.test_event`: `char` - The alignment event for the test data.
            -   `.test_time_window`: `[1x2] double` - The time window for the test data.
            -   `.test_cond1`, `.test_cond2`: `char` - The condition labels for the test data.
            -   `.trial_mask`: `char` or `cell` - A mask to select a subset of trials for testing.
        -   **For `'standard'` tests:**
            -   This test type runs a standard k-fold cross-validation on the training data of the specified model. It requires no additional fields beyond the common ones.

## Top-Level Output Structure (`session_data.analysis`)

-   `session_data.analysis`
    -   `.roc_comparison`: Results from `analyze_roc_comparison.m`
    -   `.baseline_comparison`: Results from `analyze_baseline_comparison.m`
    -   `.anova_results`: Results from `analyze_anova.m`
    -   `.behavioral_results`: Results from `analyze_behavior.m`
-   `.population_decoding`: Results from `analyze_population_decoding.m`
    -   `.selected_neurons`: List of neurons selected for analysis.
    -   `.core_data`: Processed data used for analyses.
    -   `.scSide` (for SC sessions): The determined side of the Superior Colliculus recording ('left' or 'right').
    -   `.sig_epoch_comparison` (for SC sessions): Significance of epoch comparisons from `screen_sc_neurons.m`.

---

## 1. ROC Comparison

Compares firing rates between two conditions.

-   **Path:** `session_data.analysis.roc_comparison.(eventName).(compName)`
-   **`eventName`**: `char` - The name of the alignment event (e.g., `'CUE_ON'`, `'outcomeOn'`).
-   **`compName`**: `char` - The name of the specific comparison (e.g., `'Dist_at_Cue'`, `'RPE_at_Outcome'`).

### Fields

-   `.sig`: `[nNeurons x nTimeBins] double` - Matrix indicating the direction of significant preference. +1 indicates a significant preference for condition 2, -1 indicates a significant preference for condition 1, and 0 indicates no significant difference.
-   `.time_vector`: `[1 x nTimeBins] double` - The time vector corresponding to the columns of `.sig`.
-   `.cond_names`: `[1 x 2] cell` - Cell array containing the names of the two conditions that were compared (e.g., `{'is_normal_dist', 'is_uniform_dist'}`).

---

## 2. Baseline Comparison

Compares post-event firing rates to a pre-event baseline period.

-   **Path:** `session_data.analysis.baseline_comparison.(eventName).(condName)`
-   **`eventName`**: `char` - The name of the alignment event (e.g., `'CUE_ON'`, `'outcomeOn'`).
-   **`condName`**: `char` - The name of the condition being analyzed (e.g., `'is_normal_dist'`, `'is_common_reward_no_spe'`).

### Fields

-   `.sig`: `[nNeurons x nTimeBins] double` - Matrix indicating the direction of significant change from baseline. +1 indicates a significant increase, -1 indicates a significant decrease, and 0 indicates no significant change.
-   `.time_vector`: `[1 x nTimeBins] double` - The time vector for the post-event period, corresponding to the columns of `.sig`.

---

## 3. ANOVA Results

Results from the N-way ANOVA analysis. The fields are named dynamically based on the main effects and interactions from the model. Because the analysis is split into two models (Image trials vs. Bullseye trials), the field names will be appended with a suffix to indicate which model they belong to (e.g., `Reward_ImageTrials`).

-   **Path:** `session_data.analysis.anova_results.(analysisName)`
-   **`analysisName`**: `char` - The name of the ANOVA model, taken from the `.name` field in the `anova_plan` (e.g., `'anova_imagetrials'`).

### Fields

The `(analysisName)` field contains a struct with results for each alignment event. Under each event (e.g., `.(analysisName).targetOn`), a series of fields are created, one for each term in the ANOVA model (e.g., `'p_reward'`, `'f_reward'`).

-   `.(term_p_value)`: `[1 x nTimeBins] double` - The time-resolved p-value for the term.
-   `.(term_f_stat)`: `[1 x nTimeBins] double` - The time-resolved F-statistic for the term.
-   `.time_vector`: `[1 x nTimeBins] double` - The time vector for the analysis window.

---

## 4. Behavioral Analysis Results

Stores the output from the `analyze_behavior.m` function. The results are generated by fitting a linear mixed-effects model (`fitlme`) to the behavioral data. Because the analysis is split into two models (Image trials vs. Bullseye trials), the field names will be appended with a suffix to indicate which model they belong to.

-   **Path:** `session_data.analysis.behavioral_results.(analysisName)`
-   **`analysisName`**: `char` - The name of the specific behavioral analysis, taken directly from the `.name` field in the `behavior_plan` (e.g., `'reaction_time_imagetrials'`).

### Fields

The `(analysisName)` field contains a table which is the direct output of the `anova` method called on the `fitlme` model object. This table contains the statistics for each factor and interaction term. The columns typically include:

| Column | Description |
| :--- | :--- |
| `Effect` | The name of the model term (e.g., 'reward', 'salience', 'reward:salience'). |
| `FStat` | The F-statistic for the model term. |
| `DF1` | The numerator degrees of freedom. |
| `DF2` | The denominator degrees of freedom. |
| `pValue` | The p-value indicating the significance of the model term. |
---

## 5. Population Decoding Results

Stores the output from the `analyze_population_decoding.m` function. The results are generated by training and testing SVM classifiers on neural population activity.

Results are saved in a structure where the field names are dynamically generated. For each model in the `training_plan`, a field is created with the `model_tag` name (e.g., `session_data.analysis.population_decoding.Reward_Visual`). This field stores the cross-validated classification accuracy for that model.

For each test in the `testing_plan`, a field is created with the `test_name` (e.g., `session_data.analysis.population_decoding.Reward_x_Salience_Visual`). This field stores the accuracy of the specified generalization test.

-   **Path:** `session_data.analysis.population_decoding.(analysisName)`
-   **`analysisName`**: `char` - The name of the specific decoding analysis, taken from the `model_tag` in the `training_plan` or the `test_name` in the `testing_plan`.

### Fields

-   `.accuracy`: `double` - The classification accuracy. This is the mean of the binomial distribution of correct vs. incorrect classifications.
-   `.accuracy_ci`: `[1x2] double` - The 95% confidence interval for the accuracy, calculated using `binofit`.
