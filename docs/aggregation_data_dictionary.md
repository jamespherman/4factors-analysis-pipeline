# Aggregation Data Dictionary

This document describes the canonical data structure for the `aggregated_analysis_data.mat` file. This file is the direct input to all `plot_aggregated_*` scripts and is generated by the `aggregate_analysis_results.m` script.

The design of this aggregated structure is optimized to be "plot-ready," minimizing the need for data transformations within the plotting scripts. It serves as the bridge between the per-session `session_data.analysis` structs and the final figures.

---
## Top-Level Structure

The `aggregated_analysis_data.mat` file contains two primary variables, one for each brain area, along with shared metadata.

-   `aggregated_sc_data`: `struct` - A struct containing the aggregated analysis results for all Superior Colliculus (SC) sessions.
-   `aggregated_snc_data`: `struct` - A struct containing the aggregated analysis results for all Substantia Nigra pars compacta (SNc) sessions.
-   `analysis_plan`: `struct` - A copy of the analysis plan used for the aggregation, sourced from `define_task_conditions.m`. This ensures that the plotting scripts have access to the same configuration that generated the data.
-   `session_ids`: `struct` - A struct containing the unique session identifiers for each brain area.
    -   `.sc`: `[1 x n_sc_sessions] cell` - Cell array of session IDs for SC.
    -   `.snc`: `[1 x n_snc_sessions] cell` - Cell array of session IDs for SNc.

The internal structure of `aggregated_sc_data` and `aggregated_snc_data` is identical and is detailed below.

---
## 1. Time-Resolved Analyses

For analyses that are resolved over time (ANOVA, ROC, Baseline Comparison), the data is aggregated into a nested struct organized by **Analysis Type -> Event Name -> Comparison Name**. The final leaf of this structure is a struct array, where each element corresponds to a single session. This format is optimal for plotting functions that need to compute statistics (e.g., mean proportion) across sessions.

### 1.1. ANOVA Results

-   **Path:** `.(brain_area_data).anova_results.(analysis_name).(event_name)`
-   **`analysis_name`**: `char` - The name of the ANOVA model (e.g., `'anova_imagetrials'`).
-   **`event_name`**: `char` - The name of the alignment event (e.g., `'targetOn'`).

#### Fields

The field at this path is a `[1 x nSessions] struct array` with the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `(term_p_value)`| `[nNeurons x nTimeBins] double`| A matrix of p-values for a specific model term (e.g., `p_reward`). |
| `time_vector` | `[1 x nTimeBins] double` | The time vector for the analysis window. |
| `session_id` | `char` | The unique identifier for the session. |
| `n_neurons` | `double` | The number of neurons from this session included in the analysis. |

### 1.2. ROC Comparison

-   **Path:** `.(brain_area_data).roc_comparison.(event_name).(comp_name)`
-   **`event_name`**: `char` - The name of the alignment event.
-   **`comp_name`**: `char` - The name of the comparison (e.g., `'reward'`).

#### Fields

The field at this path is a `[1 x nSessions] struct array` with the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `sig` | `[nNeurons x nTimeBins] double` | Matrix of significance results (`+1` for cond2 pref, `-1` for cond1 pref, `0` for non-sig). |
| `time_vector` | `[1 x nTimeBins] double` | The time vector for the analysis. |
| `session_id` | `char` | The unique identifier for the session. |
| `n_neurons` | `double` | The number of neurons from this session. |

### 1.3. Baseline Comparison

-   **Path:** `.(brain_area_data).baseline_comparison.(event_name).(condition_name)`
-   **`event_name`**: `char` - The name of the alignment event.
-   **`condition_name`**: `char` - The name of the condition (e.g., `'is_high_reward'`).

#### Fields

The field at this path is a `[1 x nSessions] struct array` with the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `sig` | `[nNeurons x nTimeBins] double` | Matrix of significance results (`+1` for increase, `-1` for decrease from baseline, `0` for non-sig). |
| `time_vector` | `[1 x nTimeBins] double` | The time vector for the analysis. |
| `session_id` | `char` | The unique identifier for the session. |
| `n_neurons` | `double` | The number of neurons from this session. |

---
## 2. Behavioral Analysis

For behavioral analysis, the results from each session are concatenated into a single, long-format table for each analysis type. A `session_id` column is added to maintain data provenance. This "tidy" format is required by `plot_aggregated_behavior.m` to calculate the proportion of sessions showing a significant effect.

-   **Path:** `.(brain_area_data).behavioral_results.(analysis_name)`
-   **`analysis_name`**: `char` - The name of the behavioral analysis (e.g., `'reaction_time_imagetrials'`).

#### Fields

The field at this path is a `table` with the following columns:

| Column | Description |
| :--- | :--- |
| `Effect` | The name of the model term (e.g., 'reward', 'reward:salience'). |
| `FStat` | The F-statistic for the model term. |
| `DF1` | The numerator degrees of freedom. |
| `DF2` | The denominator degrees of freedom. |
| `pValue` | The p-value indicating the significance of the model term. |
| `session_id` | The unique identifier for the session from which the row's data originates. |

---
## 3. Population Decoding

The population decoding results are aggregated into a struct organized by the test name. The final leaf is a struct array, where each element corresponds to a session, containing the accuracy and confidence interval for that session.

-   **Path:** `.(brain_area_data).population_decoding.(test_name)`
-   **`test_name`**: `char` - The name of the decoding test (e.g., `'Reward_Visual_CV'`).

#### Fields

The field at this path is a `[1 x nSessions] struct array` with the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `accuracy` | `double` | The mean classification accuracy for the test. |
| `accuracy_ci` | `[1x2] double` | The 95% confidence interval of the accuracy. |
| `session_id` | `char` | The unique identifier for the session. |

---
## 4. Window-Based ROC Analysis

The window-based ROC analysis provides single summary metrics per neuron for each factor and epoch combination. Unlike time-resolved ROC (Section 1.2), this analysis computes a single AUC value per neuron by averaging firing rates within a predefined time window.

-   **Path:** `.(brain_area_data).window_roc.(epoch_name).(factor_name)`
-   **`epoch_name`**: `char` - The semantic epoch name (e.g., `'visual'`, `'delay'`, `'perisaccade'`, `'postreward'`).
-   **`factor_name`**: `char` - The name of the factor comparison (e.g., `'reward'`, `'salience'`, `'identity'`, `'probability'`).

#### Fields

The field at this path is a `[1 x nSessions] struct array` with the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `session_id` | `char` | The unique identifier for the session. |
| `n_neurons` | `double` | The number of neurons from this session. |
| `auc` | `[nNeurons x 1] double` | ROC AUC values for each neuron (0.5 = no discrimination). |
| `p` | `[nNeurons x 1] double` | P-values from permutation test. |
| `ci` | `[nNeurons x 2] double` | 95% confidence intervals [lower, upper] for AUC. |
| `n_trials` | `[nNeurons x 2] double` | Trial counts [n_cond1, n_cond2] used for each neuron. |

#### Epoch Definitions

The epoch windows are defined in `define_task_conditions.m` and vary by brain area to account for different response latencies:

| Epoch | Alignment Event | SC Window (ms) | SNc Window (ms) |
| :--- | :--- | :--- | :--- |
| visual | targetOn | [50, 250] | [100, 300] |
| delay | fixOff | [-200, 0] | [-200, 0] |
| perisaccade | saccadeOnset | [-50, 100] | [-50, 100] |
| postreward | reward | [100, 400] | [100, 400] |

#### Usage Notes

This data structure is designed for:
1. Scatter plots comparing factor selectivity across neurons (Hypothesis 2 testing)
2. Proportion significant analyses per epoch
3. Cross-factor correlation analyses

---
## 5. Neuron Metrics Table

The neuron metrics table provides a per-neuron view of all key identifiers, metrics, and window-based ROC values in a single "tidy" table format. Each row represents one neuron from one session, enabling easy filtering, plotting, and statistical analysis.

-   **Path:** `.(brain_area_data).neuron_metrics_table`

#### Columns

| Column | Type | Description |
| :--- | :--- | :--- |
| `session_id` | `cell (char)` | Unique session identifier (e.g., `'Feynman_08_12_2025_SNc'`). |
| `cluster_id` | `double` | Cluster/unit ID within the session (from spike sorting). |
| `brain_area` | `cell (char)` | Brain area: `'SC'` or `'SNc'`. |
| `snc_subregion` | `cell (char)` | SNc subregion: `'rvmSNc'`, `'cdlSNc'`, or empty for SC. |
| `is_selected` | `logical` | Whether neuron passed screening criteria (task-modulated for SC, putative DA for SNc). |
| `baseline_fr` | `double` | Baseline firing rate in spikes/second. |
| `waveform_duration` | `double` | Peak-to-trough waveform duration in milliseconds. |
| `auc_{epoch}_{factor}` | `double` | ROC AUC value for the given epoch and factor comparison. Values range from 0 to 1, where 0.5 indicates no discrimination. |
| `p_{epoch}_{factor}` | `double` | P-value from permutation test for the corresponding AUC. |

#### Dynamic ROC Columns

The table includes ROC columns for each combination of epoch and factor defined in the analysis plan:

**Epochs:** `visual`, `delay`, `perisaccade`, `postreward`
**Factors:** `reward`, `salience`, `identity`, `probability`

This generates 16 AUC columns and 16 p-value columns:
- `auc_visual_reward`, `p_visual_reward`
- `auc_visual_salience`, `p_visual_salience`
- `auc_visual_identity`, `p_visual_identity`
- `auc_visual_probability`, `p_visual_probability`
- `auc_delay_reward`, `p_delay_reward`
- ... (and so on for all epoch Ã— factor combinations)

#### Usage Notes

This table format is designed for:
1. **Filtering**: Select only task-modulated neurons (`is_selected == true`)
2. **SNc Subregion Analysis**: Compare ROC distributions between `rvmSNc` and `cdlSNc`
3. **Scatter Plots**: Plot factor selectivity (e.g., `auc_visual_reward` vs `auc_visual_salience`)
4. **Individual Neuron Identification**: Use `session_id + cluster_id` to cross-reference with per-neuron summary PDFs
5. **Statistical Testing**: Test for significant differences between groups using p-value columns for filtering

#### Example Usage (MATLAB)

```matlab
% Load aggregated data
load('aggregated_analysis_data.mat');

% Get SNc neuron metrics table
nmt = aggregated_snc_data.neuron_metrics_table;

% Filter for selected (putative DA) neurons only
da_neurons = nmt(nmt.is_selected, :);

% Compare reward selectivity between SNc subregions
rvmSNc = da_neurons(strcmp(da_neurons.snc_subregion, 'rvmSNc'), :);
cdlSNc = da_neurons(strcmp(da_neurons.snc_subregion, 'cdlSNc'), :);

% Statistical comparison
[p, h] = ranksum(rvmSNc.auc_visual_reward, cdlSNc.auc_visual_reward);
```