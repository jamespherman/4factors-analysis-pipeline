# Aggregation Data Dictionary

This document describes the canonical data structure for the `aggregated_analysis_data.mat` file. This file is the direct input to all `plot_aggregated_*` scripts and is generated by the `aggregate_analysis_results.m` script.

The design of this aggregated structure is optimized to be "plot-ready," minimizing the need for data transformations within the plotting scripts. It serves as the bridge between the per-session `session_data.analysis` structs and the final figures.

---
## Top-Level Structure

The `aggregated_analysis_data.mat` file contains two primary variables, one for each brain area, along with shared metadata.

-   `aggregated_sc_data`: `struct` - A struct containing the aggregated analysis results for all Superior Colliculus (SC) sessions.
-   `aggregated_snc_data`: `struct` - A struct containing the aggregated analysis results for all Substantia Nigra pars compacta (SNc) sessions.
-   `analysis_plan`: `struct` - A copy of the analysis plan used for the aggregation, sourced from `define_task_conditions.m`. This ensures that the plotting scripts have access to the same configuration that generated the data.
-   `session_ids`: `struct` - A struct containing the unique session identifiers for each brain area.
    -   `.sc`: `[1 x n_sc_sessions] cell` - Cell array of session IDs for SC.
    -   `.snc`: `[1 x n_snc_sessions] cell` - Cell array of session IDs for SNc.

The internal structure of `aggregated_sc_data` and `aggregated_snc_data` is identical and is detailed below.

---
## 1. Time-Resolved Analyses

For analyses that are resolved over time (ANOVA, ROC, Baseline Comparison), the data is aggregated into a nested struct organized by **Analysis Type -> Event Name -> Comparison Name**. The final leaf of this structure is a struct array, where each element corresponds to a single session. This format is optimal for plotting functions that need to compute statistics (e.g., mean proportion) across sessions.

### 1.1. ANOVA Results

-   **Path:** `.(brain_area_data).anova_results.(analysis_name).(event_name)`
-   **`analysis_name`**: `char` - The name of the ANOVA model (e.g., `'anova_imagetrials'`).
-   **`event_name`**: `char` - The name of the alignment event (e.g., `'targetOn'`).

#### Fields

The field at this path is a `[1 x nSessions] struct array` with the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `(term_p_value)`| `[nNeurons x nTimeBins] double`| A matrix of p-values for a specific model term (e.g., `p_reward`). |
| `time_vector` | `[1 x nTimeBins] double` | The time vector for the analysis window. |
| `session_id` | `char` | The unique identifier for the session. |
| `n_neurons` | `double` | The number of neurons from this session included in the analysis. |

### 1.2. ROC Comparison

-   **Path:** `.(brain_area_data).roc_comparison.(event_name).(comp_name)`
-   **`event_name`**: `char` - The name of the alignment event.
-   **`comp_name`**: `char` - The name of the comparison (e.g., `'reward'`).

#### Fields

The field at this path is a `[1 x nSessions] struct array` with the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `sig` | `[nNeurons x nTimeBins] double` | Matrix of significance results (`+1` for cond2 pref, `-1` for cond1 pref, `0` for non-sig). |
| `time_vector` | `[1 x nTimeBins] double` | The time vector for the analysis. |
| `session_id` | `char` | The unique identifier for the session. |
| `n_neurons` | `double` | The number of neurons from this session. |

### 1.3. Baseline Comparison

-   **Path:** `.(brain_area_data).baseline_comparison.(event_name).(condition_name)`
-   **`event_name`**: `char` - The name of the alignment event.
-   **`condition_name`**: `char` - The name of the condition (e.g., `'is_high_reward'`).

#### Fields

The field at this path is a `[1 x nSessions] struct array` with the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `sig` | `[nNeurons x nTimeBins] double` | Matrix of significance results (`+1` for increase, `-1` for decrease from baseline, `0` for non-sig). |
| `time_vector` | `[1 x nTimeBins] double` | The time vector for the analysis. |
| `session_id` | `char` | The unique identifier for the session. |
| `n_neurons` | `double` | The number of neurons from this session. |

---
## 2. Behavioral Analysis

For behavioral analysis, the results from each session are concatenated into a single, long-format table for each analysis type. A `session_id` column is added to maintain data provenance. This "tidy" format is required by `plot_aggregated_behavior.m` to calculate the proportion of sessions showing a significant effect.

-   **Path:** `.(brain_area_data).behavioral_results.(analysis_name)`
-   **`analysis_name`**: `char` - The name of the behavioral analysis (e.g., `'reaction_time_imagetrials'`).

#### Fields

The field at this path is a `table` with the following columns:

| Column | Description |
| :--- | :--- |
| `Effect` | The name of the model term (e.g., 'reward', 'reward:salience'). |
| `FStat` | The F-statistic for the model term. |
| `DF1` | The numerator degrees of freedom. |
| `DF2` | The denominator degrees of freedom. |
| `pValue` | The p-value indicating the significance of the model term. |
| `session_id` | The unique identifier for the session from which the row's data originates. |

---
## 3. Population Decoding

The population decoding results are aggregated into a struct organized by the test name. The final leaf is a struct array, where each element corresponds to a session, containing the accuracy and confidence interval for that session.

-   **Path:** `.(brain_area_data).population_decoding.(test_name)`
-   **`test_name`**: `char` - The name of the decoding test (e.g., `'Reward_Visual_CV'`).

#### Fields

The field at this path is a `[1 x nSessions] struct array` with the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `accuracy` | `double` | The mean classification accuracy for the test. |
| `accuracy_ci` | `[1x2] double` | The 95% confidence interval of the accuracy. |
| `session_id` | `char` | The unique identifier for the session. |