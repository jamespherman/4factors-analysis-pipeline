# Metrics Aggregation Plan

This document defines the canonical structure for the `metrics_plan` object, which is generated by the `define_metrics_aggregation_plan.m` function. This plan serves as the single source of truth for the `aggregate_neuron_metrics.m` script, instructing it on what data to extract from the per-session `session_data.mat` files and how to structure the final aggregated output.

The plan is divided into two main components: one for aggregating simple, per-neuron scalar metrics, and another for aggregating time-resolved data arrays like PSTHs.

---

## 1. Per-Neuron Metrics Plan

This part of the plan defines the scalar metrics to be collected for **every neuron** in a session. The aggregation script will use this information to construct the columns of the final output tables (e.g., `sc_metrics`, `snc_metrics`).

-   **Path:** `metrics_plan.per_neuron_metrics`
-   **Type:** `struct array`

Each element in this struct array corresponds to one metric (i.e., one column in the output table) and contains the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `ColumnName` | `char` | The desired name for the column in the final aggregated `table` (e.g., `'BaselineFR'`). |
| `SourcePath` | `char` | The full path to the data field within the `session_data` structure, using dot notation (e.g., `'metrics.baseline_frs'`). The aggregation script will use this path to dynamically access the data. |

---

## 2. PSTH Aggregation Plan

This part of the plan defines how to find, filter, and aggregate time-resolved data arrays (specifically, PSTHs) for a **subset of neurons** (e.g., only those selected by a screening function).

-   **Path:** `metrics_plan.psth_aggregation`
-   **Type:** `struct`

This struct contains a single, comprehensive set of instructions for the PSTH aggregation task:

| Field | Type | Description |
| :--- | :--- | :--- |
| `SourcePath` | `char` | The base path to the struct containing the event-aligned data (e.g., `'analysis.core_data.spikes'`). |
| `Events` | `cell` | A cell array of strings listing the specific event fields to process from within the `SourcePath` (e.g., `{'fixOn', 'targetOn', ...}`). |
| `DataField` | `char` | The name of the field within each event struct that contains the binned firing rate data (e.g., `'rates'`). The data at this location is expected to be a `[n_neurons x n_trials x n_bins]` matrix. |
| `SelectorPath` | `char` | The path to the logical vector that will be used to select which neurons' PSTHs to aggregate (e.g., `'analysis.selected_neurons'`). The aggregation script will use this mask to filter the `DataField` matrix along its first dimension (neurons). |